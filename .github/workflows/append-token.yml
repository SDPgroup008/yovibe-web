name: Append Token

on:
  repository_dispatch:
    types: [append_token]

jobs:
  append:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Append token with retry logic
        run: |
          MAX_RETRIES=10
          RETRY_COUNT=0
          SUCCESS=false
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "Attempt $((RETRY_COUNT + 1)) of $MAX_RETRIES..."
            
            # Pull latest changes first
            git pull origin main
            
            # Append the token and capture exit code
            set +e  # Don't exit on error
            node -e "
            const fs = require('fs');
            const path = 'tokens.json';
            const payload = JSON.parse(process.env.CLIENT_PAYLOAD);
            const token = payload.token;
            let tokens = [];
            if (fs.existsSync(path)) {
              tokens = JSON.parse(fs.readFileSync(path, 'utf-8'));
            }
            if (!tokens.includes(token)) {
              tokens.push(token);
              fs.writeFileSync(path, JSON.stringify(tokens, null, 2));
              console.log('Appended token:', token);
              process.exit(0);
            } else {
              console.log('Token already exists, skipping.');
              process.exit(100);
            }
            "
            NODE_EXIT_CODE=$?
            set -e  # Re-enable exit on error
            
            # Check if token was appended (exit code 0) or already exists (exit code 100)
            if [ $NODE_EXIT_CODE -eq 100 ]; then
              echo "✅ Token already exists. No changes needed."
              SUCCESS=true
              break
            fi
            
            # If token was added, commit and push
            if [ $NODE_EXIT_CODE -eq 0 ]; then
              git add tokens.json
              git commit -m "Append new FCM token"
              
              # Try to push
              if git push origin main; then
                echo "✅ Push successful!"
                SUCCESS=true
                break
              else
                echo "❌ Push failed. Retrying..."
                RETRY_COUNT=$((RETRY_COUNT + 1))
                
                if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                  # Reset to match remote before retry
                  git reset --hard origin/main
                  
                  # Wait with exponential backoff
                  WAIT_TIME=$((RETRY_COUNT * 2))
                  echo "⏳ Waiting ${WAIT_TIME} seconds before retry..."
                  sleep $WAIT_TIME
                fi
              fi
            else
              echo "❌ Unexpected error from node script (exit code: $NODE_EXIT_CODE)"
              exit 1
            fi
          done
          
          if [ "$SUCCESS" = false ]; then
            echo "❌ Failed to append and push token after $MAX_RETRIES attempts"
            exit 1
          fi
          
          echo "✅ Workflow completed successfully"
        env:
          CLIENT_PAYLOAD: ${{ toJson(github.event.client_payload) }}
          GITHUB_TOKEN: ${{ github.token }}
