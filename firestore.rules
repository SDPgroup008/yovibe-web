rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions - MUST be defined before use
    function isAdmin(uid) {
      return uid != null && exists(/databases/$(database)/documents/YoVibe/data/admins/$(uid));
    }
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function: check if only latitude and longitude are being updated
    function onlyUpdatingCoordinates() {
      let affectedKeys = request.resource.data.diff(resource.data).affectedKeys();
      return affectedKeys.hasOnly(['latitude', 'longitude']) 
        || affectedKeys.hasOnly(['latitude']) 
        || affectedKeys.hasOnly(['longitude']);
    }
    
    // Helper function: check if adding coordinates to a venue that has none
    function addingMissingCoordinates() {
      let hasNoCoordinates = !('latitude' in resource.data) || resource.data.latitude == null;
      let addingCoordinates = 'latitude' in request.resource.data && request.resource.data.latitude != null;
      return hasNoCoordinates && addingCoordinates;
    }
    
    // YoVibe data collection - default deny
    match /YoVibe/data/{document=**} {
      allow read, write: if false;
    }
    
    // Users collection
    match /YoVibe/data/users/{userId} {
      allow read, write: if request.auth != null;
    }
    
    // Events collection
    match /YoVibe/data/events/{eventId} {
      allow read: if true; // Public read access for events
      allow write: if request.auth != null;
      allow update: if true;
    }
    
    // Vibe ratings collection
    match /YoVibe/data/vibeRatings/{ratingId} {
      allow read: if true; // Public read access for vibe ratings
      allow write: if request.auth != null;
    }
    
    // Vibe images collection
    match /YoVibe/data/vibeImages/{imageId} {
      allow read: if true; // Public read access for vibe images
      allow write: if request.auth != null;
    }
    
    // Notifications collection
    match /YoVibe/data/notifications/{notificationId} {
      // Anyone can read broadcast notifications (userId == null)
      // Authenticated users can read their own notifications
      // Admins can read all notifications
      allow read: if resource.data.userId == null || 
        (isAuthenticated() && request.auth.uid == resource.data.userId) || 
        isAdmin(request.auth.uid);
      
      // ANYONE can create notifications (to allow FCM/GitHub workflow integration)
      allow create: if true;
      
      // Authenticated users can update their own notifications or broadcast notifications
      allow update: if isAuthenticated() && 
        (request.auth.uid == resource.data.userId || resource.data.userId == null);
      
      // Only admins can delete notifications
      allow delete: if isAdmin(request.auth.uid);
    }
    
    // Notification Analytics collection
    match /YoVibe/data/notification_analytics/{analyticsId} {
      // Only admins can read notification analytics
      allow read: if isAdmin(request.auth.uid);
      
      // System can create and update analytics
      allow create, update: if true;
      
      // Prevent deletion
      allow delete: if false;
    }
    
    // Daily Notification Stats collection
    match /YoVibe/data/daily_notification_stats/{statsId} {
      // Only admins can read daily notification stats
      allow read: if isAdmin(request.auth.uid);
      
      // System can create and update daily stats
      allow create, update: if true;
      
      // Prevent deletion
      allow delete: if false;
    }
    
    // Notification User Interactions collection
    match /YoVibe/data/notification_user_interactions/{interactionId} {
      // Only admins can read user interaction data
      allow read: if isAdmin(request.auth.uid);
      
      // System can create and update user interactions
      allow create, update: if true;
      
      // Prevent deletion
      allow delete: if false;
    }
    
    // Reports: users can create reports; only admins can read/update
    match /YoVibe/data/reports/{reportId} {
      allow create: if request.auth != null && request.resource.data.reporterId == request.auth.uid;
      allow read, update: if isAdmin(request.auth.uid);
      allow delete: if false;
    }

    // Venues: allow reading for ALL users (authenticated or not)
    // Allow ALL users to update ONLY latitude and longitude fields (for geocoding)
    match /YoVibe/data/venues/{venueId} {
      allow read: if true; // Public read access for all users
      
      // Allow ANY user (authenticated or not) to update only coordinates (for geocoding)
      allow update: if onlyUpdatingCoordinates() || addingMissingCoordinates();
      
      // Only authenticated users (admins and venue owners) can create venues
      allow create: if request.auth != null 
        && (isAdmin(request.auth.uid) || request.resource.data.ownerId == request.auth.uid);
      
      // Only admins and venue owners can delete venues
      allow delete: if request.auth != null && (
        isAdmin(request.auth.uid) 
        || get(/databases/$(database)/documents/YoVibe/data/venues/$(venueId)).data.ownerId == request.auth.uid
      );
    }
    
    // Analytics sessions collection
    match /analytics_sessions/{sessionId} {
      // Anyone can create a session
      allow create: if true;

      // Only the session owner (or system) can update their session
      allow update: if request.auth.uid == resource.data.userId || resource.data.userId == null;

      // Only admins can read analytics data
      allow read: if request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.userType == 'admin';

      // Prevent deletion
      allow delete: if false;
    }
    
    // Tickets collection
    match /YoVibe/data/tickets/{ticketId} {
      // Users can read their own tickets
      allow read: if isAuthenticated() && 
        request.auth.uid == resource.data.userId;
      
      // Admins can read all tickets
      allow read: if isAdmin(request.auth.uid);
      
      // Authenticated users can create tickets
      allow create: if isAuthenticated();
      
      // Users can update their own tickets
      allow update: if isAuthenticated() && 
        request.auth.uid == resource.data.userId;
      
      // Admins can delete tickets
      allow delete: if isAdmin(request.auth.uid);
    }
    
    // Default deny for any other paths
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
